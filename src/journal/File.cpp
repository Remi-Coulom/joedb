#include "File.h"

/////////////////////////////////////////////////////////////////////////////
// System-specific file locking
/////////////////////////////////////////////////////////////////////////////
#ifdef _WIN32
#include <Windows.h>
#include <io.h>
#include <FileAPI.h>
bool joedb::File::lock_file()
{
 HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));
 return LockFile(hFile, 0, 0, 1, 0) == TRUE;
}
#else
#include <sys/file.h>
bool joedb::File::lock_file()
{
 return flock(fileno(file), LOCK_EX | LOCK_NB) == 0;
}
#endif

/////////////////////////////////////////////////////////////////////////////
// System-specific sync
/////////////////////////////////////////////////////////////////////////////
#ifdef WIN32
#include <io.h>
#else
#include <unistd.h>
#endif

void joedb::File::sync()
{
#ifdef WIN32
 _commit(_fileno(file));
#else
 fsync(fileno(file));
#endif
}

/////////////////////////////////////////////////////////////////////////////
void joedb::File::open(const char *file_name, mode_t new_mode)
/////////////////////////////////////////////////////////////////////////////
{
 reset();

 mode = new_mode;
 static const char *mode_string[3] = {"rb", "r+b", "w+b"};
 file = std::fopen(file_name, mode_string[static_cast<size_t>(mode)]);

 if (file)
 {
  if (lock_file())
  {
   std::setvbuf(file, 0, _IONBF, 0);
   status = status_t::success;
  }
  else
  {
   std::fclose(file);
   file = 0;
   status = status_t::locked;
  }
 }
 else
  status = status_t::failure;
}

/////////////////////////////////////////////////////////////////////////////
size_t joedb::File::read_buffer()
/////////////////////////////////////////////////////////////////////////////
{
 return std::fread(buffer, 1, buffer_size, file);
}

/////////////////////////////////////////////////////////////////////////////
void joedb::File::write_buffer()
/////////////////////////////////////////////////////////////////////////////
{
 std::fwrite(buffer, 1, write_buffer_index, file);
}

/////////////////////////////////////////////////////////////////////////////
int joedb::File::seek(size_t offset)
/////////////////////////////////////////////////////////////////////////////
{
 return std::fseek(file, long(offset), SEEK_SET);
}

/////////////////////////////////////////////////////////////////////////////
joedb::File::~File()
/////////////////////////////////////////////////////////////////////////////
{
 flush();
 if (file)
  fclose(file);
}
