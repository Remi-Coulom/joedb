#include "joedb/Stream_File.h"
#include "joedb/Exception.h"

/////////////////////////////////////////////////////////////////////////////
joedb::Stream_File::Stream_File(std::iostream &stream, Open_Mode mode):
/////////////////////////////////////////////////////////////////////////////
 stream(stream)
{
 this->mode = mode;

 if (!stream.good())
  throw Exception("Bad stream");
}

/////////////////////////////////////////////////////////////////////////////
int64_t joedb::Stream_File::get_size() const
/////////////////////////////////////////////////////////////////////////////
{
 const std::streampos pos = stream.tellg();
 stream.seekg(0, std::ios_base::end);
 const std::streampos result = stream.tellg();
 stream.seekg(pos);
 return int64_t(result);
}

/////////////////////////////////////////////////////////////////////////////
size_t joedb::Stream_File::read_buffer()
/////////////////////////////////////////////////////////////////////////////
{
 return size_t(stream.readsome(buffer, std::streamsize(buffer_size)));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Stream_File::write_buffer()
/////////////////////////////////////////////////////////////////////////////
{
 stream.write(buffer, std::streamsize(write_buffer_index));
}

/////////////////////////////////////////////////////////////////////////////
int joedb::Stream_File::seek(int64_t offset)
/////////////////////////////////////////////////////////////////////////////
{
 stream.seekg(std::streampos(offset));
 stream.seekp(std::streampos(offset));

 int result = 0;
 if (!stream.good())
 {
  stream.clear();
  result = 1;
 }

 return result;
}
