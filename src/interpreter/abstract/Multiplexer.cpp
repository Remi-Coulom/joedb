#include "Multiplexer.h"

/////////////////////////////////////////////////////////////////////////////
joedb::Internal_Writeable::Internal_Writeable
/////////////////////////////////////////////////////////////////////////////
(
 Multiplexer *multiplexer,
 size_t id
):
 multiplexer(multiplexer),
 id(id)
{
}

#define MULTIPLEX(x) do {\
 if (!multiplexer->multiplexing) {\
  multiplexer->multiplexing = true;\
  for (size_t i = 0; i < multiplexer->external_writeables.size(); i++) \
   if (i != id) \
    multiplexer->external_writeables[i]->x;\
  multiplexer->multiplexing = false;\
 }\
} while(0)

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::create_table(const std::string &name)
/////////////////////////////////////////////////////////////////////////////
{
 MULTIPLEX(create_table(name));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::drop_table(table_id_t table_id)
/////////////////////////////////////////////////////////////////////////////
{
 MULTIPLEX(drop_table(table_id));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::rename_table
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 const std::string &name
)
{
 MULTIPLEX(rename_table(table_id, name));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::add_field
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 const std::string &name,
 Type type
)
{
 MULTIPLEX(add_field(table_id, name, type));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::drop_field
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 field_id_t field_id
)
{
 MULTIPLEX(drop_field(table_id, field_id));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::rename_field
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 field_id_t field_id,
 const std::string &name
)
{
 MULTIPLEX(rename_field(table_id, field_id, name));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::custom(const std::string &name)
/////////////////////////////////////////////////////////////////////////////
{
 MULTIPLEX(custom(name));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::comment(const std::string &comment)
/////////////////////////////////////////////////////////////////////////////
{
 MULTIPLEX(comment(comment));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::timestamp(int64_t timestamp)
/////////////////////////////////////////////////////////////////////////////
{
 MULTIPLEX(timestamp(timestamp));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::valid_data()
/////////////////////////////////////////////////////////////////////////////
{
 MULTIPLEX(valid_data());
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::insert
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 record_id_t record_id
)
{
 MULTIPLEX(insert(table_id, record_id));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::insert_vector
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 record_id_t record_id,
 record_id_t size
)
{
 MULTIPLEX(insert_vector(table_id, record_id, size));
}

/////////////////////////////////////////////////////////////////////////////
void joedb::Internal_Writeable::delete_record
/////////////////////////////////////////////////////////////////////////////
(
 table_id_t table_id,
 record_id_t record_id
)
{
 MULTIPLEX(delete_record(table_id, record_id));
}

#define TYPE_MACRO(type, return_type, type_id, R, W)\
void joedb::Internal_Writeable::update_##type_id\
(\
 table_id_t table_id,\
 record_id_t record_id,\
 field_id_t field_id,\
 return_type value\
)\
{\
 MULTIPLEX(update_##type_id(table_id, record_id, field_id, value));\
}\
\
void joedb::Internal_Writeable::update_vector_##type_id\
(\
 table_id_t table_id,\
 record_id_t record_id,\
 field_id_t field_id,\
 record_id_t size,\
 const type *value\
)\
{\
 MULTIPLEX\
 (\
  update_vector_##type_id(table_id, record_id, field_id, size, value)\
 );\
}
#include "joedb/TYPE_MACRO.h"
#undef TYPE_MACRO
#undef MULTIPLEX

/////////////////////////////////////////////////////////////////////////////
joedb::Writeable &joedb::Multiplexer::add_writeable(Writeable &external_writeable)
/////////////////////////////////////////////////////////////////////////////
{
 const size_t id = external_writeables.size();

 external_writeables.push_back(&external_writeable);
 internal_writeables.push_back(
  std::unique_ptr<Internal_Writeable>(new Internal_Writeable(this, id)));
 // TODO later: C++14 has std::make_unique. Should be used here in the future.

 return *internal_writeables.back();
}
